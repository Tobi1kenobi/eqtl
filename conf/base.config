/*
========================================================================================
    nf-core/eqtl Nextflow base config file
========================================================================================
    A 'blank slate' config file, appropriate for general use on most high performance
    compute environments. Assumes that all software is installed and available on
    the PATH. Runs in `local` mode - all jobs will be run on the logged in environment.
----------------------------------------------------------------------------------------
*/
params{
    chunkSize=20
    mem1= 10000


    LIMIX{
        run=false
        callRate=0.95
        blockSize=1500
        hwe=0.0000001
    }

    SAIGE{
        run=true
        nr_expression_pcs=5
        // chromosomes_to_test=[1,2,3,4,5,6,7,8,9,10.11,12,13,14,15,16,17,18,19,20,21,X]
        chromosomes_to_test=[1,2] 
        minMAF=0.05
        minMAC=20
        SPAcutoff=2
        markers_per_chunk=10000
    }

    TensorQTL{
        run=true
        use_gt_dosage = true 
        optimise_pcs = true
        interaction_file='' // to run interaction, provide a TSV with genotype ID and interaction 
        interaction_maf = 0.1
        interaction_pc_cor_threshold = 0.25 // Drop PCs correlated with interaction above this threshold. Use 1 if you don not want to drop PCs
        trans_by_cis=true // Run trans-by-cis analysis (all genes, limiting variants) following OPTIM PCs?
        trans_of_cis=true // Run trans-of-cis eQTL analysis (all variants, limiting genes), following OPTIM PCs?
        trans_by_cis_pval_threshold = 0.01
        alpha=0.05
    }
    
    outdir='results'
    copy_mode = "rellink"
    genotype_phenotype_mapping_file=''
    utilise_gpu = false
    gtf_type='gene' //# 'gene|transcript'
    input_tables_column_delimiter = '\t' 
    n_min_cells = '5' // The number of cells for individual to use. 
    n_min_individ = '30' //Do not select less than 25 since this may result in a permutation issue with tensorqtl
    aggregation_method = 'dMean,dSum' // can be: dMean, dSum or both separated by comma
    dMean_norm_method = 'cp10k' // Normlisation method for dMean, can be cp10k or a precomputed normalised counts layer in the anndata file
    inverse_normal_transform = 'FALSE' // Inverse normal trasnform data as part of normalisation
    bcftools_filters = '--max-alleles 2 -m2 -M2 -v snps'
    //plink2_filters = '--allow-extra-chr 0 --chr 1-22 XY --indep-pairwise 250 50 0.2 --snps-only --rm-dup exclude-all'
    plink2_filters = '--allow-extra-chr 0 --chr 1-22 XY --snps-only --rm-dup exclude-all'
    maf = 0.1
    hwe= 0.0000001
    windowSize=1000000
    numberOfPermutations=1000
    filter_method = 'HVG' // filterByExpr|HVG|None
    norm_method = 'DESEQ'  //'DESEQ|TMM|NONE'
    percent_of_population_expressed=0.2 // whats the proportion of individuals that has to have the value !=0, Please do not go below 2% as this will result in a lot of low expressed genes which will cause issues in SAIGE and TensorQTL
    tmpdir = "${launchDir}/work"
    aggregation_columns='Azimuth:predicted.celltype.l1' //for the scrna h5ad file define which annotations to use when aggregating the data. Can be one value or multiple comma separated values
    
    covariates{
        nr_phenotype_pcs = '2,4'
        nr_genotype_pcs = 4
        extra_covariates_file = ''
    }

    eqtl_container = 'https://yascp.cog.sanger.ac.uk/public/singularity_images/eqtl_08_07_2024.sif'
    eqtl_docker='mercury/eqtl:08_07_2024'

    saige_container = 'https://yascp.cog.sanger.ac.uk/public/singularity_images/saigeeqtl_0_1_0.sif'
    saige_docker='mercury/saige_eqtl:25_07_2024'
    limix_container='/lustre/scratch123/hgi/mdt1/projects/cardinal_analysis/analysis/mb47/limixJune24.simg'
    
}


process {
    cache = 'lenient'
    maxRetries    = 5
    maxErrors     = '-1'
    errorStrategy = 'retry'
    cpus   = {  1    * task.attempt }
    memory = {  4.GB * task.attempt }
    time   = { 4.h  * task.attempt }


    withLabel:process_high_memory {
        memory = { 200.GB * task.attempt  }
    }
    withLabel:process_medium_memory {
        memory = { 200.GB * task.attempt }
    }

    withLabel:process_tiny {
      cpus = 1
      maxRetries    = 5
      memory = 2.GB
      time   = {  3.h   * task.attempt }
    }

    withLabel:process_low {
        cpus   = { 1     * task.attempt    }
        memory = { 4.GB * task.attempt }
        time   = { 12.h   * task.attempt   }
    }
    withLabel:process_medium {
        cpus   = { 6     * task.attempt   }
        memory = { 12.GB * task.attempt  }
        time   = { 6.h   * task.attempt    }
    }
    withLabel:process_high {
        cpus   = { 12    * task.attempt    }
        memory = { 20.GB * task.attempt }
        time   = { 16.h  * task.attempt   }
    }

    withLabel:error_ignore {
        errorStrategy = 'ignore'
    }
    withLabel:error_retry {
        errorStrategy = 'retry'
        maxRetries    = 2
    }
    withName: LIMIX{
        errorStrategy = { task.attempt <= 2 ? 'retry' : 'ignore' }
    }    
    withName: SAIGE_S1{
        time   = { 1.h   * task.attempt    }
    }
    withName: SAIGE_QVAL_COR{
        time   = { 15.min   * task.attempt    }
        queue = 'small'
    }
    withName: SAIGE_S2{
        time   = { 15.min   * task.attempt    }
        queue = 'small'
    }
    withName: SAIGE_S3{
        time   = { 1.h   * task.attempt    }
    }
}

singularity {
    enabled = true
    autoMounts = true
    runOptions = '--nv'
}